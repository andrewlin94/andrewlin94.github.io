<!DOCTYPE html>
<head>
  <script src="jquery-3.3.1.min.js"></script>  
  <script type="text/javascript">
  var apikey = "4d59e65a82617e3bbc45a3870fc05ada";
  var apiurl = "https://api.openweathermap.org/data/2.5/weather?"
  var cityList = [];
  var countryList = [];
  populateCountryList();

  function getWeather() { 
    // let location = "zip=" + document.getElementById("zipcode").value + "," + document.getElementById("countrycode").value;
    let selectedCity = document.getElementById("citySelect").value;
    let location = "id=" + selectedCity;
    let url =  apiurl + location + "&units=metric" + "&appid=4d59e65a82617e3bbc45a3870fc05ada";
    fetch(url).then(response => {
      return response.json();
    }).then(data => {
      // Work with JSON data here
      console.log(data);
      document.getElementById("latitude").value = data.coord.lat + String.fromCharCode(176);
      document.getElementById("longitude").value = data.coord.lon + String.fromCharCode(176);
      document.getElementById("temp").value = data.main.temp +  String.fromCharCode(176) + "C";
      document.getElementById("humid").value = data.main.humidity + String.fromCharCode(37);
      document.getElementById("condition").value = data.weather[0].main;
      document.getElementById("wspeed").value = data.wind.speed + " m/s";
      document.getElementById("wdir").value = data.wind.deg + String.fromCharCode(176);
    }).catch(err => {
      // Do something for an error here
      console.log("Invalid Location");
    });
  }

  function populateCountryList() {
    $.getJSON("https://raw.githubusercontent.com/andrewlin94/JSWeather/master/city.list.json", function(json) {
      for (let index in json) {
        if (json.hasOwnProperty(index)) {
          let item = json[index];
          // console.log(countryList.indexOf(item.country));
          if (countryList.indexOf(item.country) == -1 && item.country != "") {
            countryList.push(item.country);
          }
        }
      }
      let select = document.getElementById("countrySelect");
      for (let i = 0; i < countryList.length; ++i) {
        let opt = countryList[i];
        let el = document.createElement("option");
        el.textContent = opt;
        el.value = opt;
        select.appendChild(el);
      }
    });
  }

  function populateCityList(country) {
    let select = document.getElementById("citySelect");
    let length = select.options.length;
    cityList = [];
    for (let i = 0; i < length; ++i) {
      select.remove(0);
    }
    let emptyEle = document.createElement("option");
    emptyEle.textContent = "Choose your city";
    select.add(emptyEle);
    $.getJSON('https://raw.githubusercontent.com/andrewlin94/JSWeather/master/city.list.json', function(json) {
      for (let name in json) {
        if (json.hasOwnProperty(name)) {
          let item = json[name];
          let selectedCountry = countryList[country];
          if (item.country == selectedCountry) {
            cityList.push({
              name: item.name,
              id: item.id
            });
          }
        }
      }
      let select = document.getElementById("citySelect");
      for (let i = 0; i < cityList.length; ++i) {
        let opt = cityList[i].name;
        let el = document.createElement("option");
        el.textContent = opt;
        el.value = cityList[i].id;
        select.add(el);
      }
    });
  }
  // function removeSelect() {
  //   var select = document.getElementById("citySelect");
  //   select.remove(0);
  // }
  </script>
</head>
<html>
  <form id="inputLocation">
    <select id="countrySelect" onchange="if (this.selectedIndex) populateCityList(this.selectedIndex - 1);">
      <option value="-1">Choose your country</option>
    </select> 
    <select id="citySelect">
      <option>Choose your city</option>
    </select> 
  </form>
  <br>
  <form id="currentWeather">
    Condition: <output type="text" id="condition"></output><br>
    Latitude: <output type="number" id="latitude"></output><br>  
    Longitude: <output type="number" id="longitude"></output><br>
    Temperature: <output type="number" id="temp"></output><br>
    Humidity: <output type="number" id="humid"></output><br>
    Wind Speed: <output type="number" id="wspeed"></output><br>
    Wind Direction: <output type="number" id="wdir"></output>
  </form>
  <button onclick=getWeather()>Get Weather</button>
  <!-- <button onclick=removeSelect()>Remove</button> -->
</html>